---
- name: Deploy SPE Scientific Calculator using Docker Compose
  hosts: local
  become: true
  vars:
    project_dir: "{{ lookup('env','WORKSPACE') }}"  # Jenkins workspace or target path

  pre_tasks:
    - name: Ensure Docker is installed
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Ensure Docker Compose is installed
      apt:
        name: docker-compose
        state: present
        update_cache: yes

    - name: Ensure python3-pip is installed (required for Ansible Docker collection)
      apt:
        name: python3-pip
        state: present
        update_cache: yes

    - name: Install community.docker collection if not present
      ansible.builtin.command: ansible-galaxy collection install community.docker
      changed_when: false

  tasks:
    - name: Deploy and manage containers with Docker Compose
      community.docker.docker_compose:
        project_src: "{{ project_dir }}"
        project_name: spe_sci_calc
        state: present       # ensures containers are running
        pull: true           # pulls latest images
        restarted: true      # stops and removes old containers before starting new ones
      become: true

    - name: Verify running containers
      shell: docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
      register: docker_ps_output
      ignore_errors: yes

    - debug:
        msg: "{{ docker_ps_output.stdout }}"
