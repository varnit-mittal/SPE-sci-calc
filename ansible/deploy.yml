---
- name: Deploy SPE Scientific Calculator using Docker Compose
  hosts: local
  become: true
  vars:
    project_dir: "{{ lookup('env','WORKSPACE') }}"  # Path on local or target server
    compose_file: "{{ project_dir }}/docker-compose.yml"

  tasks:
    - name: Ensure Docker is installed
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Ensure Docker Compose is installed
      apt:
        name: docker-compose
        state: present
        update_cache: yes

    - name: Stop and remove existing containers (if any)
      command: docker-compose -f {{ compose_file }} down --remove-orphans
      args:
        chdir: "{{ project_dir }}"
      ignore_errors: yes

    - name: Remove unused Docker networks and images
      shell: docker system prune -af
      ignore_errors: yes

    - name: Pull latest images from Docker Hub
      command: docker-compose -f {{ compose_file }} pull
      args:
        chdir: "{{ project_dir }}"

    - name: Start containers using pulled images
      command: docker-compose -f {{ compose_file }} up -d
      args:
        chdir: "{{ project_dir }}"

    - name: Verify containers are running
      command: docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
      register: docker_ps_output

    - debug:
        msg: "{{ docker_ps_output.stdout }}"
